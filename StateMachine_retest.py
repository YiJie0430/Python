import ConfigParser,os,sys,time,thread,threading,htx,serial
from tftp import tftpcfg, tftp_engine
import PcapMachine 
from testlibs import *
import wx.richtext as rt
import wx
import traceback
import htx
from sysVars import *
import buildkey
from Retest import *
import StringIO
#execfile('sysVars.py') 
if os.path.isfile('c:\\station.ini'):
   execfile('c:\\station.ini') 

ConfigDirectory =os.getcwd()# os.path.join(os.getcwd(),'config')
sys.path.append(ConfigDirectory)
if os.path.isfile('%s\\__init__.py'%ConfigDirectory):
   execfile('%s\\__init__.py'%ConfigDirectory) 

class StateMachine:
      def __init__(self,parent):
          self.ConfigFilePath=''
          self.ConfigFile=[]
          self.parent=parent
          self.PcapServer=''
          self.label_name=''
          self.emp = parent.emp
          
      def _in_action(self):
          id_ = self.parent.ScanLabel.GetValue().strip()[-1]
          if id_ not in ('1','2','3','4','5','6','7','8') or len(self.parent.ScanLabel.GetValue()) > 4:
              self._scan_msg("Input dut id (1~8) error : %s"%id_) 
              return 
          id_ = int(id_)-1
          if self.parent.DUT_LIST[id_][0].GetBackgroundColour() in self.parent.flash: 
             self._scan_msg("DUT %s in the test"%(id_+1)) 
             return 
          for p in range(8):
              if self.parent.DUT_LIST[p][0].GetBackgroundColour()==self.parent.ActionColor:
                 self.parent.DUT_LIST[p][0].SetBackgroundColour(self.parent.DisableColor) 
                 self.parent.DUT_LIST[p][0].Refresh()
          self.parent.DUT_LIST[id_][0].SetBackgroundColour(self.parent.ActionColor) 
          self.parent.DUT_LIST[id_][2].SetValue('')
          self.parent.DUT_LIST[id_][3].SetValue('')
          self.parent.DUT_LIST[id_][4].SetValue('')
          self.parent.DUT_LIST[id_][5].SetValue(0)
          self.parent.DUT_LIST[id_][6].SetValue('')
          self.parent.DUT_LIST[id_][0].SetToolTipString('')
          dutid = self.parent.DUT_LIST[id_][1].GetLabel()
          self.parent.DUT_LIST[id_][1].SetLabel(dutid[:6])
          self.parent.DUT_LIST[id_][0].Refresh()
          self.dutid = id_
          self.labels=[]
          self.label_id=0
          self.label_name=''
          self.parent.DUT_LIST[id_][-1].SetValue('')
          self.label_name = self.LabelType[self.label_id].split(',')[0].strip().upper() 
          self._in_label(self.label_name)       
          
      def state(self,val):
          if val=='PN':self._init()
          else:
             label_ = self.parent.ScanLabel.GetValue() 
             if 'CANCEL'==label_.strip().upper():
                self._in_dutid() 
                return 
             if 'CHECK'==label_.strip().upper():
                self.CheckDialog() 
                return
          if val=='DUT ID':self._in_action()
          if val== self.label_name : self._check_label()
      
      def CheckDialog(self):
          try:
             self.ConfigFile.get('Base','CheckDialog')
             if "Dialog.exe" not in os.popen("tasklist").read():
                os.startfile("C:\\AFIMainGui\\Dialog.exe")
                return
             self._scan_msg("failed: Dialog is show")
             self.parent.ScanLabel.SetBackgroundColour( "red" ) 
          except:
             self.parent.CheckLED_Dialog.ShowModal()    
                      
      def _check_label(self):
          val_ = self.parent.ScanLabel.GetValue()  
          len_ = self.LabelType[self.label_id].split(',')[1].strip()
          chart_= self.LabelType[self.label_id].split(',')[2].strip()
          if len(val_) <> int(len_) or chart_ <> val_[:len(chart_)]:
             self._scan_msg("Label format error ,length %s ,fix chart %s : %s"%(len_,chart_,val_)) 
             return 
          if len(self.LabelType[self.label_id].split(',')) > 3:
                try: int(val_,16)
                except:
                   self._scan_msg("Label format error ,length %s ,fix chart %s : %s"%(len_,chart_,val_)) 
                   return
          if self.label_id < 2:
             for d in range(8):
                 if val_==self.parent.DUT_LIST[d][2].GetValue() or val_==self.parent.DUT_LIST[d][3].GetValue() :
                    c_ = self.parent.DUT_LIST[d][0].GetBackgroundColour()
                    if c_<>self.parent.RedColor and c_<>self.parent.LimeColor and c_<>self.parent.DisableColor:
                       self._scan_msg("Bar code scanning repetition") 
                       return 
          self.labels.append(val_)
          if self.label_id==0:
             self.parent.DUT_LIST[self.dutid][2].SetValue(val_)
          elif self.label_id==1:
             self.parent.DUT_LIST[self.dutid][3].SetValue(val_)
          if self.label_id == len(self.LabelType)-1:
             MainFunction(self,'test').start()
             self._in_dutid()
             
          else:
             self.label_id += 1  
             self.label_name = self.LabelType[self.label_id].split(',')[0].strip().upper() 
             self._in_label(self.label_name)              
      
      def _in_label(self,name):
          self.parent.LabelName.SetLabel(name)
          self.parent.ScanLabel.SetBackgroundColour( "yellow" )
          self.parent.StatusBar.SetStatusText("Please input %s label"%name)

      def close(self):
          if type(self.parent.TFTPServer)<>type(''):
             self.parent.TFTPServer.shutdown()
          if self.PcapServer:
             self.PcapServer.close()
      
      def _in_dutid(self):
          self.parent.LabelName.SetLabel('DUT ID')
          self.parent.ScanLabel.SetBackgroundColour( "yellow" )
          self.parent.StatusBar.SetStatusText("Please input dut id (1~8)")
          self.parent.ScanLabel.Enable(True)
      
      def _show_test_state(self,pos,color=0,errcode='',errinfo=''):
          colors_=(self.parent.YellowColor,self.parent.RedColor,self.parent.LimeColor)
          self.parent.DUT_LIST[pos][0].SetBackgroundColour(colors_[color]) 
          self.parent.DUT_LIST[pos][0].SetToolTipString(errinfo)
          dutid = self.parent.DUT_LIST[pos][1].GetLabel()
          if errcode:
             self.parent.DUT_LIST[pos][1].SetLabel(dutid[:6]+' - %s'%errcode)
          self.parent.DUT_LIST[pos][0].Refresh()
          
      def _scan_msg(self,e):
          self.parent.StatusBar.SetStatusText(e)
          self.parent.ScanLabel.SetBackgroundColour( "red" )
          
      def _int_msg(self,e):
          self.close()
          time.sleep(1)
          self.parent.StatusBar.SetStatusText(e)
          self.parent.LabelName.SetLabel('PN')
          self.parent.ScanLabel.SetBackgroundColour( "red" )
          self.parent.ScanLabel.Enable(True)
      
      def _set_gauge_range(self,range_):
          for ind_ in range(8):
              self.parent.DUT_LIST[ind_][5].SetRange(range_)
                         
      def _init(self):
          self.PN=self.parent.ScanLabel.GetValue()
          self.ConfigFilePath='%s\\%s.ini'%(ConfigDirectory,self.PN)
          self.ConfigFile=ConfigParser.SafeConfigParser()
          if not self.ConfigFile.read(self.ConfigFilePath):
             self._int_msg("Cannot find the %s models"%self.PN) 
             return 
          else:
             #self.parent.ScanLabel.SetBackgroundColour( "Green" )  
             self.parent.configfile = self.ConfigFilePath
             self.parent.ScanLabel.Enable(False)
             self.parent.StatusBar.SetStatusText(self.parent.InitStr) 
             self.parent.LabelName.SetLabel('INIT')
             #read tftp config
             try:
                #cfgdict = tftpcfg.getconfigstrict(ConfigDirectory, self.ConfigFilePath)
                cfgdict = tftpcfg.getconfigstrict(ConfigDirectory, 'tftp.ini')
                self.ModelName = self.ConfigFile.get('Base','ModelName')
                self.StationName = self.ConfigFile.get('Base','StationName')
                self.parent.TFTPPath.SetLabel(self.ConfigFile.get('TFTPSERVER','tftprootfolder'))
                self.AFI_LANIP = self.ConfigFile.get('AFI','LANIP')
                self.AFI_ETH0IP = self.ConfigFile.get('AFI','ETH0IP')
                self.AFI_VLAN1IP = self.ConfigFile.get('AFI','VLAN1IP')
                self.AFI_CARDS = self.ConfigFile.get('AFI','CARDS')
                self.TELNET = self.ConfigFile.get('Base','TELNET')
                self.Puma7 = self.ConfigFile.get('Base','Puma7_console')
                self.LANIP = self.ConfigFile.get('Base','LANIP')
                self.ATOM = self.ConfigFile.get('Base','ATOM')
                self.LabelType = self.ConfigFile.get('Base','LabelType').split('|') 
                self.config = self.ConfigFile  
                self.parent.Flows = self.Flows = map(strip,self.ConfigFile.get('Base','Flows').split(','))
                self.promp = self.ConfigFile.get('Base','promp')
                self.Retest_opt=self.ConfigFile.get('Base','Retest_opt')
                self.AFILog_Copy=self.ConfigFile.get('Base','AFILog_Copy')
                self.AFILog_Encrypt=self.ConfigFile.get('Base','AFILog_Encrypt')
                self.mfglog = self.ConfigFile.get('Base','mfglog_path')
                self.mfgrcd = self.ConfigFile.get('Base','mfgrcd_path')
                self.rcdlog = self.ConfigFile.get('Base','rcdlog_path')
                for flow_ in self.Flows:
                    self.ConfigFile.items(flow_)
                self._set_gauge_range(len(self.Flows))
             except tftpcfg.ConfigError, e:
                self._int_msg("Error in config file : %s of [TFTPSERVER] section"%e)
                return 
             except ConfigParser.NoSectionError,e:
                self._int_msg("Error in config file : %s"%e)
                return 
             except ConfigParser.NoOptionError,e:
                self._int_msg("Error in config file : %s"%e)
                return 
             self.logPath = "c:\\%s-Log\\"%self.ModelName+"-".join(map(str,time.gmtime()[:3]))+"\\"
             if not os.path.isdir(self.logPath):
                os.system("mkdir %s"%self.logPath)
             self.parent.ModuleName.SetLabel(self.ModelName) 
             self.parent.StationName.SetLabel(self.StationName)
             self.parent.TFTPServer = tftp_engine.ServerState(**cfgdict)
             #thread.start_new_thread(tftp_engine.loop_nogui, (self.parent.TFTPServer,))
             self.parent.TFTPServerState.SetBackgroundColour("yellow")
             time.sleep(1)
             #if not self.parent.TFTPServer.serving:
             #   self._int_msg(self.parent.TFTPServer.text.split('\n')[-1])
             #   return
             self.parent.AFIServerState.SetBackgroundColour("yellow")
             self.parent.AFIServerState.Refresh()
             self.PcapServer=PcapMachine.server(self)           
             if not self.PcapServer.state:
                self.parent.AFIServerState.SetBackgroundColour("red")
                self.parent.AFIServerState.Refresh()
                return  
             MainFunction(self).start()
              


class MainFunction(threading.Thread):
      def __init__(self,parent,state='init'):
          threading.Thread.__init__(self)
          self.parent = parent
          self.state = state
          self.msg = ''
          self.emp = parent.emp
          self.StationName = self.parent.StationName
          self.term_record = None

      def _init(self):
          '''AFI Init and install patarmete'''
          try: 
              term_c = (SocketTTY(self.parent.parent.Buffers,(0,0)),SocketTTY(self.parent.parent.Buffers,(1,0))) 
              for i in range(1):
                  #detection ccu card
                  for wait_s in range(10):
                      term_c[i] << 'info'
                      if 'info' in term_c[i].wait('info',3)[-1]: break
                      elif wait_s==9 : raise Except('CCU %s not found'%i)
                  #detection other cards
                  for wait_s in range(10):
                      info = lWaitCmdTerm(term_c[i],'info','info',3)
                      flag_ = 1
                      for card in self.parent.AFI_CARDS.split('|')[i].split(','):
                          if card.strip().upper() not in info:
                             if wait_s==9:raise Except('CCU %s : %s not found'%(i,card))
                             flag_ = 0
                             break
                      if flag_:break       
                  term_cb = (SocketTTY(self.parent.parent.Buffers,(0,1)),SocketTTY(self.parent.parent.Buffers,(1,1))) 
                  ports=['1','2','3','4']
                  for termcb in term_cb:
                      for p in ports:
                          lWaitCmdTerm(termcb,'rf %s n'%p,'OK',3)
                      break                      
                  #set ccu eth0 and vlan ip
                  mask_ = '255.255.255.0'
                  eth0_=self.parent.AFI_ETH0IP.split('|')
                  vlan1_=self.parent.AFI_VLAN1IP
                  lWaitCmdTerm(term_c[i],'ip %s %s %s %s'%(eth0_[i],mask_,vlan1_,mask_),'OK',3)
                  #set ccu prelay 
                  lWaitCmdTerm(term_c[i],'prelay 69 eth0 69 %s 1'%self.parent.AFI_LANIP,'OK',3)  #tftp prelay
                  for v_ in range(1,8):
                      for p_ in range(1,5):
                          if p_ == 2: lWaitCmdTerm(term_c[i],'prelay 30%s%s vlan%s%s 23 %s 23'%(v_,p_,v_,p_,self.parent.ATOM),'OK',3)  #ATOM_telnet prelay
                          else: lWaitCmdTerm(term_c[i],'prelay 30%s%s vlan%s%s 23 %s 23'%(v_,p_,v_,p_,self.parent.LANIP),'OK',3)  #ARM_telnet prelay                     
              self.parent._in_dutid()
              self.parent.parent.AFIServerState.SetBackgroundColour("blue")
              self.parent.parent.AFIServerState.Refresh()
          except Except,msg:
              self.parent._int_msg(str(msg))
              self.parent.parent.AFIServerState.SetBackgroundColour("red")
              self.parent.parent.AFIServerState.Refresh()
      
      def SetPanel(self,*argv):
          ''' argv = sate , errcode , errinfo
              state = start,fail,pass,flash1,flash2,flash2,flash4          
          '''
          self.parent.parent.DUT_LIST[self.dutid][0].SetLabel('')  
          if argv[0] == 'start':self.parent._show_test_state(self.dutid)
          if argv[0] == 'fail' : 
             self.parent._show_test_state(self.dutid,color = 1,errcode=argv[1],errinfo=argv[2]) 
          if argv[0] == 'pass':self.parent._show_test_state(self.dutid,color = 2)
          if argv[0] == 'flash1':self.parent.parent.DUT_LIST[self.dutid][0].SetLabel('3')
          if argv[0] == 'flash2':self.parent.parent.DUT_LIST[self.dutid][0].SetLabel('4') 
          if argv[0] == 'flash3':self.parent.parent.DUT_LIST[self.dutid][0].SetLabel('5')  
          if argv[0] == 'flash4':self.parent.parent.DUT_LIST[self.dutid][0].SetLabel('6')   
      
      def SetLog(self,s,color=0,item=None):
          '''
             color : 0  --  white
                     1  --  red
                     2  --  lime
          '''
          colors=[(255,255,255),(255,0,0),(0,255,0)]
          s += '\n'
          if self.log and not self.log.closed:
             self.log.write(s)
             self.log.flush() 
          lines = len(s.split("\n"))
          self.parent.parent.DUT_LIST[self.dutid][-1].Freeze()
          beg = self.parent.parent.DUT_LIST[self.dutid][-1].GetLastPosition()
          end = beg + len(s)
          self.parent.parent.DUT_LIST[self.dutid][-1].AppendText(s)
          self.parent.parent.DUT_LIST[self.dutid][-1].SetStyle(beg,end,wx.TextAttr(colors[color],'black'))
          self.parent.parent.DUT_LIST[self.dutid][-1].ScrollLines( lines + 1 )
          self.parent.parent.DUT_LIST[self.dutid][-1].ShowPosition(end)
          self.parent.parent.DUT_LIST[self.dutid][-1].Thaw()          
          #below is for AFIlog stored in the /nvram.
          if item.__class__ is list: item.append(s)
          if self.term_record and int(self.parent.AFILog_Copy) : 
             buf = StringIO.StringIO(s)
             for line in buf.readlines():
                 line=line.strip()
                 self.term_record << "echo '%s' >> %s"%(line,self.parent.mfglog)
          self.itemlog.append(s)

      def SetProcess(self,flow):
          self.parent.parent.DUT_LIST[self.dutid][4].SetValue(flow)
          val_ = self.parent.parent.DUT_LIST[self.dutid][5].GetValue()
          self.parent.parent.DUT_LIST[self.dutid][5].SetValue(val_+1)       
      
      def GetConfig(self,section,item):
          return self.parent.ConfigFile.get(section,item).strip()  
      
      def ExcuteCmd(self,term,cmds):
          for cmd_ in map(strip,cmds):
              if not cmd_:continue
              cmd,waitstr,timeout,count=map(strip,cmd_.split(','))
              c_port = self.dutid
              if c_port > 3 : c_port  -=  4
              if cmd in self.cmd_pwd_dict: 
                 term << cmd
                 if waitstr in term.wait(waitstr,5)[-1]: continue
                 for try_ in range(6): 
                     lWaitCmdTerm(self.term[0],'uartd close %s'%c_port,'ok',5)
                     term << self.cmd_pwd_dict[cmd] 
                     time.sleep(0.5)                       
                     term << cmd
                     lWaitCmdTerm(self.term[0],'uartd open %s 0'%c_port,'ok',5) 
                     term << ''
                     data = term.wait(waitstr,5)[-1]
                     if waitstr in data : break 
                     if try_==5:raise Except('failed: %s,%s'%(cmd,data)) 
                 continue               
              lWaitCmdTerm(term,cmd,waitstr,float(timeout),int(count))
   
             
      def run(self):
          self.test_flag=1
          if self.state=='init':
             #self.parent._in_dutid() 
             self._init()
          else:
             try:
                 self.AFILog_copy=int(self.parent.AFILog_Copy)
                 self.consoleboard_flag=int(self.parent.Puma7.split('|')[0].strip())
                 self.comport=str(self.parent.Puma7.split('|')[-1].strip())
                 self.comport=self.comport.split(',')
                 self.result = ['FAIL',1]
                 self.errcode = ''
                 self.errinfo = ''                 
                 self.dutid=self.parent.dutid
                 self.port=self.dutid+1
                 if self.port >4 : self.port -= 4
                 self.starttime=time.time()             
                 sw_id_ = self.dutid + 2
                 vm_id_ = self.dutid/2 + 6
                 dut_id_ = self.dutid+8
                 tport_ = '30%s1'%(self.dutid+1)
                 if self.dutid > 3:
                    sw_id_ = self.dutid - 2
                    vm_id_ = (self.dutid-4)/2 + 6
                    tport_ = '30%s1'%(self.dutid-3)
                    dut_id_ = self.dutid + 4
                 self.term=[]          #[CCU,CB,SW,VM,DUT]
                 self.term.append(SocketTTY(self.parent.parent.Buffers,(self.dutid/4,0)))            #ccu term
                 self.term.append(SocketTTY(self.parent.parent.Buffers,(self.dutid/4,1)))            #CB term
                 self.term.append(SocketTTY(self.parent.parent.Buffers,(self.dutid/4,sw_id_)))       #SW term    
                 self.term.append(SocketTTY(self.parent.parent.Buffers,(self.dutid/4,vm_id_)))       #VM term              
                 if int(self.parent.TELNET.strip()):
                    self.term.append(htx.Telnet(self.parent.LANIP,int(tport_)))                      #Dut telnet
                 elif self.consoleboard_flag:                                                        #COM Port
                    print 'uartd by consoleboard'
                    comport=self.comport[self.dutid]
                    comport=comport.split('_'); print comport
                    self.term.append(htx.SerialTTY(comport[1],'115200'))                             #ATOM
                    self.term.append(htx.SerialTTY(comport[0],'115200'))                             #ARM  
                    #self.term_console=(htx.SerialTTY(comport[0],'115200'))                             #ARM  
                 else:
                    pass
                    #self.term.append(SocketTTY(self.parent.parent.Buffers,(self.dutid/4,dut_id_)))   #Dut term
                 self.labels=self.parent.labels #0:mac,1:sn,2:ssid,3:wpakey
                 #self.parent.parent.DUT_LIST[self.dutid][-1].Enable( False ) 
                 #self.SetPanel('start')
                 self.log=open('%s%s.%s'%(self.parent.logPath,self.labels[0],self.StationName),'w')
                 self.Flog=open('%s%s_fusion.%s'%(self.parent.logPath,self.labels[0],self.StationName),'a')
                 self.itemlog=list()
                 self.Return=[self.parent.parent.CheckLED_Dialog,self.parent.parent.emp]
                 self.AFILog=None
                 self.LogItem=None
                 if self.AFILog_copy:                     
                    self.AFILog=Item_log()
                    self.AFILog.add('start')
                    self.LogItem=self.AFILog['start']
                 self.SetLog("%s test program , %s , Station: %s ; dut_id:%s"%(self.parent.ModelName,VERSION,STATION,int(self.dutid)+1),item=self.LogItem)
                 self.SetLog("EMP : %s"%self.emp,item=self.LogItem)
                 self.SetLog("------------------------------------------------------------------------------",item=self.LogItem)
                 self.SetLog("Start Time : %s"%time.asctime(),item=self.LogItem)
                 self.mac = self.labels[0]
                 self.SetLog("MAC Address : %s"%self.mac,item=self.LogItem)
                 if len(self.labels) > 1:
                    self.sn = self.labels[1]
                    self.SetLog("Serial Number : %s"%self.sn,item=self.LogItem)
                 if len(self.labels) > 2:
                    self.ssid = self.labels[2]
                    self.SetLog("SSID : %s"%self.ssid,item=self.LogItem)
                 if len(self.labels) > 3:
                    self.wpakey = self.labels[3]
                    self.SetLog("WPAKey : %s"%self.wpakey,item=self.LogItem)   
                 self.cmd_pwd_dict = eval(self.GetConfig('Base','CMD_PWD_DICT'))
                 self.term[1] << 'rf %s n'%self.port
                 #######################################################################################          
                 self.retest_init=0
                 self.rcd=None
                 self.retest_flag=0
                 #self.term_record=None
                 for idx,flow in enumerate(self.parent.Flows):
                     print flow
                     self.itemlog=list()
                     self.SetPanel('start')
                     self.SetProcess(self.GetConfig(flow,'FlowName'))
                     #self.Parameter = map(strip,self.GetConfig(flow,'Parameter').split('|'))
                     #print self.GetConfig(flow,'Enable').strip()
                     if flow == 'AtomTelnet':
                        if int(self.GetConfig(flow,'Enable').strip()):
                            value=eval('%s(self.dutid,self.term,self.labels,self.SetPanel,self.SetLog,self.GetConfig,flow,[self.Return])'%self.GetConfig(flow,'FunctionName'))
                            self.term_record=value[1]
                            if int(self.parent.Retest_opt):
                                self.retest_flag=value[0]
                                self.retest=R_Flow(self.term_record,self.parent.promp,self.retest_init)
                                self.rcd=self.retest.GetMfgRecord(self.term_record,self.parent.Flows,self.parent.mfgrcd); print (self.rcd)
                                self.retest.SetMfgRecord(self.term_record,self.rcd,int(idx-1),1,self.parent.mfgrcd)                            
                            if not self.retest_init and not int(self.rcd[-1]) and self.AFILog_copy:
                                self.retest_init=1
                                self.Flog=open('%s%s_fusion.%s'%(self.parent.logPath,self.labels[0],self.StationName),'w')
                                for log in self.AFILog['start']:
                                    self.term_record << "echo '%s' >> %s"%(log,self.parent.mfglog);time.sleep(0.01)
                                    self.Flog.write(log)
                                    self.Flog.flush()                           
                            if not self.retest_init and int(self.rcd[-1]) and self.AFILog_copy:
                               self.retest_init=1                                
                               self.Flog=open('%s%s_fusion.%s'%(self.parent.logPath,self.labels[0],self.StationName),'a')
                               stime=''.join(self.AFILog['start']).split('Start Time :')[-1].split('MAC Address :')[0].strip()
                               self.term_record << "echo '-----------retest %s, start time: %s-----------' >> %s"%(self.rcd[-1],stime,self.parent.mfglog);time.sleep(0.01)
                               self.Flog.write('\n-----------retest %s, start time: %s-----------\n'%(self.rcd[-1],stime))
                               self.Flog.flush()
                            self.Flog.write(''.join(self.itemlog))
                            self.Flog.flush()
                        continue    
                     if self.retest_flag:
                        if not self.retest.ChkMfgRecord(self.rcd,idx):
                           if int(idx)>=1: self.retest.SetMfgRecord(self.term_record,self.rcd,int(idx-1),1,self.parent.mfgrcd)
                           self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'InCmd').split('|')))
                           if int(self.GetConfig(flow,'Enable').strip()):
                              eval('%s(self.dutid,self.term,self.labels,self.SetPanel,self.SetLog,self.GetConfig,flow,[self.Return])'%self.GetConfig(flow,'FunctionName'))
                              #if flow == self.parent.Flows[-1]: self.retest.SetMfgRecord(self.term_record,self.rcd,int(idx),1,self.parent.mfgrcd)
                           self.Flog.write(''.join(self.itemlog))
                           self.Flog.flush()
                           if flow == self.parent.Flows[-1]: self.retest.SetMfgRecord(self.term_record,self.rcd,int(idx),1,self.parent.mfgrcd)
                           self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'OutCmd').split('|')))
                        else:
                           self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'InCmd').split('|')))
                           if int(self.GetConfig(flow,'Reserve').strip()):
                              if int(self.GetConfig(flow,'Enable').strip()):
                                 eval('%s(self.dutid,self.term,self.labels,self.SetPanel,self.SetLog,self.GetConfig,flow,[self.Return])'%self.GetConfig(flow,'FunctionName'))
                              self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'OutCmd').split('|')))
                           else:
                              self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'OutCmd').split('|')))
                              self.SetLog(flow+' check',2)
                              continue
                     else: 
                        self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'InCmd').split('|')))
                        if int(self.GetConfig(flow,'Enable').strip()):
                           eval('%s(self.dutid,self.term,self.labels,self.SetPanel,self.SetLog,self.GetConfig,flow,[self.Return])'%self.GetConfig(flow,'FunctionName'))
                        self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'OutCmd').split('|')))
                     
                 ######################################################################################
                 if self.retest_flag: self.retest.SaveRcdLog(self.term_record,self.rcd,self.parent.rcdlog)
                 self.result=('PASS',2)
                 if len(self.term)>4: del self.term[4:]
             except Except,msg:
                 if self.retest_flag: self.retest.SaveRcdLog(self.term_record,self.rcd,self.parent.rcdlog)
                 msg = str(msg)[:500]
                 if 'ErrorCode' not in msg:
                    msg = 'ErrorCode(0000):'+msg
                 self.errcode = msg.split('ErrorCode(')[-1].split(')')[0]
                 self.errinfo = str(msg)
                 self.SetLog(msg,1)
                 self.result=('FAIL',1)
                 self.test_flag=0
                 if len(self.term)>4: del self.term[4:]
             except:
                 if self.retest_flag: self.retest.SaveRcdLog(self.term_record,self.rcd,self.parent.rcdlog)
                 msg=str(traceback.format_exc())
                 if 'ErrorCode' not in msg:
                     msg = 'ErrorCode(0001):'+msg
                 self.errcode = msg.split('ErrorCode(')[-1].split(')')[0]
                 self.errinfo = str(msg)
                 self.SetLog(msg,1)
                 self.result=('FAIL',1)
                 self.test_flag=0
                 if len(self.term)>4: del self.term[4:]
             self.itemlog=list()
             self.term[1] << 'rf %s n'%self.port
             self.term[0] << 'uartd close %s'%(self.port-1)
             self.SetLog("End Time : %s"%time.asctime())
             self.SetLog("Total Time : %s"%(time.time()-self.starttime))
             self.SetLog("Test Result:%s"%self.result[0],self.result[1])
             if self.log: self.log.close(); print 'fuckmfg'
             if int(self.result[1]) == 2:
                self.Flog.write(''.join(self.itemlog))
                self.Flog.flush()
             if self.Flog: self.Flog.close()

             self.SetPanel(self.result[0].lower(),self.errcode,self.errinfo);
             if len(self.term)>4: del self.term[4:]
             if self.AFILog_copy and int(self.parent.AFILog_Encrypt) and self.result[0]=='PASS':
                self.encrypt=Encryption(self.term_record)
                self.encrypt.encrypt(self.parent.mfglog)

      def run_loop(self):
          self.test_flag=1
          if self.state=='init':
             #self.parent._in_dutid() 
             self._init()
          else:
             try:
                 self.AFILog_copy=int(self.parent.AFILog_Copy)
                 self.consoleboard_flag=int(self.parent.Puma7.split('|')[0].strip())
                 self.comport=str(self.parent.Puma7.split('|')[-1].strip())
                 self.comport=self.comport.split(',')
                 self.result = ['FAIL',1]
                 self.errcode = ''
                 self.errinfo = ''
                 self.log = ''
                 self.dutid=self.parent.dutid
                 self.port=self.dutid+1
                 if self.port >4 : self.port -= 4
                 self.starttime=time.time()             
                 sw_id_ = self.dutid + 2
                 vm_id_ = self.dutid/2 + 6
                 dut_id_ = self.dutid+8
                 tport_ = '30%s1'%(self.dutid+1)
                 if self.dutid > 3:
                    sw_id_ = self.dutid - 2
                    vm_id_ = (self.dutid-4)/2 + 6
                    tport_ = '30%s1'%(self.dutid-3)
                    dut_id_ = self.dutid + 4
                 self.term=[]          #[CCU,CB,SW,VM,DUT]
                 self.term.append(SocketTTY(self.parent.parent.Buffers,(self.dutid/4,0)))            #ccu term
                 self.term.append(SocketTTY(self.parent.parent.Buffers,(self.dutid/4,1)))            #CB term
                 self.term.append(SocketTTY(self.parent.parent.Buffers,(self.dutid/4,sw_id_)))       #SW term    
                 self.term.append(SocketTTY(self.parent.parent.Buffers,(self.dutid/4,vm_id_)))       #VM term              
                 if int(self.parent.TELNET.strip()):
                    self.term.append(htx.Telnet(self.parent.LANIP,int(tport_)))                      #Dut telnet
                 elif self.consoleboard_flag:                                                        #COM Port
                    print 'uartd by consoleboard'
                    comport=self.comport[self.dutid]
                    comport=comport.split('_'); print comport
                    self.term.append(htx.SerialTTY(comport[1],'115200'))                             #ATOM
                    self.term.append(htx.SerialTTY(comport[0],'115200'))                             #ARM  
                    #self.term_console=(htx.SerialTTY(comport[0],'115200'))                             #ARM  
                 else:
                    pass
                    #self.term.append(SocketTTY(self.parent.parent.Buffers,(self.dutid/4,dut_id_)))   #Dut term
                 self.labels=self.parent.labels #0:mac,1:sn,2:ssid,3:wpakey
                 #self.parent.parent.DUT_LIST[self.dutid][-1].Enable( False ) 
                 #self.SetPanel('start')
                 self.log=open('%s%s.%s'%(self.parent.logPath,self.labels[0],self.StationName),'w')
                 self.Return=[self.parent.parent.CheckLED_Dialog,self.parent.parent.emp]
                 for t in xrange(5):
                     self.roundtime=time.time()
                     try:
                         self.AFILog=None
                         self.LogItem=None
                         if self.AFILog_copy:                     
                            self.AFILog=Item_log()
                            self.AFILog.add('start')
                            self.LogItem=self.AFILog['start']
                         self.SetLog("@@@@@@@@@@ Test NO.%d @@@@@@@@@@"%(t+1),item=self.LogItem)
                         self.SetLog("%s test program , %s , Station: %s ; dut_id:%s"%(self.parent.ModelName,VERSION,STATION,int(self.dutid)+1),item=self.LogItem)
                         self.SetLog("EMP : %s"%self.emp,item=self.LogItem)
                         self.SetLog("------------------------------------------------------------------------------",item=self.LogItem)
                         self.SetLog("Start Time : %s"%time.asctime(),item=self.LogItem)
                         self.mac = self.labels[0]
                         self.SetLog("MAC Address : %s"%self.mac,item=self.LogItem)
                         if len(self.labels) > 1:
                            self.sn = self.labels[1]
                            self.SetLog("Serial Number : %s"%self.sn,item=self.LogItem)
                         if len(self.labels) > 2:
                            self.ssid = self.labels[2]
                            self.SetLog("SSID : %s"%self.ssid,item=self.LogItem)
                         if len(self.labels) > 3:
                            self.wpakey = self.labels[3]
                            self.SetLog("WPAKey : %s"%self.wpakey,item=self.LogItem)   
                         self.cmd_pwd_dict = eval(self.GetConfig('Base','CMD_PWD_DICT'))
                         self.term[1] << 'rf %s n'%self.port
                         #######################################################################################          
                         self.retest_init=0
                         self.rcd=None
                         self.retest_flag=0
                         #self.term_record=None
                         for idx,flow in enumerate(self.parent.Flows):
                             print flow
                             self.SetPanel('start')
                             self.SetProcess(self.GetConfig(flow,'FlowName'))
                             #self.Parameter = map(strip,self.GetConfig(flow,'Parameter').split('|'))
                             #print self.GetConfig(flow,'Enable').strip()
                             if flow == 'AtomTelnet':
                                if int(self.GetConfig(flow,'Enable').strip()):
                                    value=eval('%s(self.dutid,self.term,self.labels,self.SetPanel,self.SetLog,self.GetConfig,flow,[self.Return])'%self.GetConfig(flow,'FunctionName'))
                                    self.term_record=value[1]
                                    if not self.retest_init and self.AFILog_copy:
                                        for log in self.AFILog['start']:
                                            self.term_record << "echo '%s' >> %s"%(log,self.parent.mfglog);time.sleep(0.01)
                                    if int(self.parent.Retest_opt):
                                        self.retest_flag=value[0]
                                        self.retest=R_Flow(self.term_record,self.parent.promp,self.retest_init)
                                        self.rcd=self.retest.GetMfgRecord(self.term_record,self.parent.Flows,self.parent.mfgrcd)
                                        self.retest_init=1
                                        self.retest.SetMfgRecord(self.term_record,self.rcd,int(idx-1),1,self.parent.mfgrcd)
                                continue    
                             if self.retest_flag:
                                if not self.retest.ChkMfgRecord(self.rcd,idx):
                                   if int(idx)>=1: self.retest.SetMfgRecord(self.term_record,self.rcd,int(idx-1),1,self.parent.mfgrcd)
                                   print self.term
                                   self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'InCmd').split('|')))
                                   if int(self.GetConfig(flow,'Enable').strip()):
                                      eval('%s(self.dutid,self.term,self.labels,self.SetPanel,self.SetLog,self.GetConfig,flow,[self.Return])'%self.GetConfig(flow,'FunctionName'))
                                      #if flow == self.parent.Flows[-1]: self.retest.SetMfgRecord(self.term_record,self.rcd,int(idx),1,self.parent.mfgrcd)
                                   if flow == self.parent.Flows[-1]: self.retest.SetMfgRecord(self.term_record,self.rcd,int(idx),1,self.parent.mfgrcd)
                                   self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'OutCmd').split('|')))
                                else:
                                   self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'InCmd').split('|')))
                                   if int(self.GetConfig(flow,'Reserve').strip()):
                                      if int(self.GetConfig(flow,'Enable').strip()):
                                         eval('%s(self.dutid,self.term,self.labels,self.SetPanel,self.SetLog,self.GetConfig,flow,[self.Return])'%self.GetConfig(flow,'FunctionName'))
                                      self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'OutCmd').split('|')))
                                   else:
                                      self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'OutCmd').split('|')))
                                      self.SetLog(flow+' check',2)
                                      continue
                             else: 
                                self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'InCmd').split('|')))
                                if int(self.GetConfig(flow,'Enable').strip()):
                                   eval('%s(self.dutid,self.term,self.labels,self.SetPanel,self.SetLog,self.GetConfig,flow,[self.Return])'%self.GetConfig(flow,'FunctionName'))
                                self.ExcuteCmd(self.term[-1],map(strip,self.GetConfig(flow,'OutCmd').split('|')))
                             
                         ######################################################################################
                         if self.retest_flag: self.retest.SaveRcdLog(self.term_record,self.rcd,self.parent.rcdlog)
                         self.result=('PASS',2)
                         self.SetLog("$$$$$$$$$$$$ Test NO.%d time: %d sec $$$$$$$$$$$$"%((t+1),(time.time()-self.roundtime)))
                         self.term[-1]<<'top'
                         self.term[-1]<<'reboot'
                         if len(self.term)>4:
                            del self.term[4:]
                         time.sleep(50)
                     except:
                         if self.retest_flag: self.retest.SaveRcdLog(self.term_record,self.rcd,self.parent.rcdlog)
                         msg=str(traceback.format_exc())
                         if 'ErrorCode' not in msg:
                             msg = 'ErrorCode(0001):'+msg
                         self.errcode = msg.split('ErrorCode(')[-1].split(')')[0]
                         self.errinfo = str(msg)
                         self.SetLog(msg,1)
                         self.result=('FAIL',1)
                         self.test_flag=0 
                         if len(self.term)>4:
                            self.term[-1]<<'exit'
                            time.sleep(2)
                            self.term[-1]<<'qu'
                            del self.term[4:]
                         continue

             except Except,msg:
                 if self.retest_flag: self.retest.SaveRcdLog(self.term_record,self.rcd,self.parent.rcdlog)
                 msg = str(msg)[:500]
                 if 'ErrorCode' not in msg:
                    msg = 'ErrorCode(0000):'+msg
                 self.errcode = msg.split('ErrorCode(')[-1].split(')')[0]
                 self.errinfo = str(msg)
                 self.SetLog(msg,1)
                 self.result=('FAIL',1)
                 self.test_flag=0
                 if len(self.term)>4:
                    self.term[-1]<<'qu'
                    del self.term[4:]
             except:
                 if self.retest_flag: self.retest.SaveRcdLog(self.term_record,self.rcd,self.parent.rcdlog)
                 msg=str(traceback.format_exc())
                 if 'ErrorCode' not in msg:
                     msg = 'ErrorCode(0001):'+msg
                 self.errcode = msg.split('ErrorCode(')[-1].split(')')[0]
                 self.errinfo = str(msg)
                 self.SetLog(msg,1)
                 self.result=('FAIL',1)
                 self.test_flag=0
                 if len(self.term)>4:
                    self.term[-1]<<'qu'
                    del self.term[4:]
             self.term[1] << 'rf %s n'%self.port
             self.term[0] << 'uartd close %s'%(self.port-1)
             self.SetLog("End Time : %s"%time.asctime())
             self.SetLog("Total Time : %s"%(time.time()-self.starttime))
             self.SetLog("Test Result:%s"%self.result[0],self.result[1])
             if self.log:self.log.close(); print 'fuckmfg'
             self.SetPanel(self.result[0].lower(),self.errcode,self.errinfo);
             if self.AFILog_copy and int(self.parent.AFILog_Encrypt) and self.result[0]=='PASS':
                self.encrypt=Encryption(self.term_record)
                self.encrypt.encrypt(self.parent.mfglog)
             if len(self.term)>4:
                self.term[-1]<<'qu'
                del self.term[4:]      





































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































